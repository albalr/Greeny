name: Django CI

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

env: 
  POSTGRES_NAME: ${{ secrets.POSTGRES_NAME }}
  POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
  POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
  POSTGRES_HOST: ${{ secrets.DB_HOST }}

jobs:
 test:
   runs-on: ubuntu-latest
   
   services:
      postgres:
        image: postgres

        env:
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_DB: ${{ secrets.POSTGRES_NAME }}

        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
   
   steps:
   - uses: actions/checkout@v4
   - uses: actions/setup-python@v5
     with:
      python-version: '3.12'

   - name: Install dependencies
     working-directory: Backend
     run: |
       pip install -r requirements.txt
       python manage.py makemigrations
       python manage.py migrate
   - name: Run tests
     working-directory: Backend
     run: python manage.py test
