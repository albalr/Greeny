name: Django CI

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

env: 
  POSTGRES_NAME: ${{ secrets.POSTGRES_NAME }}
  POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
  POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}

jobs:
 test:
   runs-on: ubuntu-latest
   
   services:
    image: postgres
    env:
    - POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
    - POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
    - POSTGRES_BD: ${{ secrets.POSTGRES_NAME }}
    ports:
    - 5432:5432
    options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
   
   steps:
   - uses: actions/checkout@v2
   - name: Set up Python 3.8.9
   - uses: actions/setup-python@v2
     with:
      python-version: 3.8.9

   - name: Install dependencies
     run: pip install -r requirements.txt
   - name: Run tests
     run: python manage.py test
